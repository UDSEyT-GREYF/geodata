<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Datos clave de aeropuertos ‚Äì GeoData ORSNA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS para el mini mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }

    a { color: #0072bb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* TOPBAR */
    .topbar {
      background-color: #002855;
      color: #fff;
      font-size: 0.85rem;
      padding: 4px 16px;
    }
    .topbar-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* HEADER ORSNA */
    .gov-header {
      background-color: #ffffff;
      border-bottom: 1px solid #dde2e6;
    }
    .gov-header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00a3e0, #0072bb);
    }

    .brand-text { display: flex; flex-direction: column; }
    .brand-text span:first-child {
      font-size: 0.78rem;
      text-transform: uppercase;
      color: #6c757d;
    }
    .brand-text span:last-child {
      font-size: 1.1rem;
      font-weight: 600;
      color: #002855;
    }

    /* BREADCRUMB */
    .breadcrumb {
      background-color: #eef2f7;
      border-bottom: 1px solid #dde2e6;
      font-size: 0.85rem;
    }
    .breadcrumb-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 8px 16px;
      color: #6c757d;
    }

    /* MAIN */
    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header.page-header {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .page-header-left h1 {
      font-size: 1.8rem;
      font-weight: 600;
      color: #002855;
    }
    .page-header-left p {
      margin-top: 4px;
      color: #555;
      font-size: 0.95rem;
    }

    .selector {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.9rem;
    }
    .selector label { color: #444; }
    .selector select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #c0c7d4;
      font-size: 0.9rem;
      min-width: 220px;
    }

    /* KPI STRIP */
    .kpi-strip {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
      margin: 10px 0 18px;
    }
    .kpi-card {
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #d0d7e2;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      font-size: 0.8rem;
      text-align: center;
    }
    .kpi-card img {
      width: 52px;
      height: 52px;
      object-fit: contain;
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2a5fa0;
      line-height: 1.1;
    }
    .kpi-label {
      color: #555;
      font-size: 0.78rem;
    }

    /* GRID DE FICHAS ‚Äì disposici√≥n con √°reas */
    .grid {
      display: grid;
      grid-template-columns: 2fr 2fr 2fr;
      grid-template-areas:
        "superficie terminal ubicacion"
        "movimiento terminal concesion"
        "empleo servicios servicios";
      gap: 12px;
      margin-top: 8px;
    }

    .panel {
      background: #fff;
      border-radius: 4px;
      border: 1px solid #d0d7e2;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      background: #306fb0;
      color: #fff;
      padding: 6px 10px;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .panel-body {
      padding: 8px 10px 10px;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      font-size: 0.9rem;
    }
    .metric-row .value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2a5fa0;
    }

    .small-label {
      font-size: 0.8rem;
      color: #777;
    }

    ul {
      padding-left: 18px;
      font-size: 0.88rem;
    }

    .subpanel-title {
      margin-top: 4px;
      font-weight: 600;
      color: #2a5fa0;
      font-size: 0.9rem;
    }

/* === SUPERFICIE como 2 KPIs (texto arriba, imagen abajo) === */
.panel-superficie {
  grid-area: superficie;
}

.panel-superficie .panel-body {
  padding: 8px 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.superficie-kpi {
  display: flex;
  flex-direction: column;       /* üëà texto arriba, imagen abajo */
  align-items: stretch;
  gap: 6px;
  border: 1px solid #d0d7e2;
  border-radius: 4px;
  padding: 6px 8px;
  background: #ffffff;/* fondo blanco */
}

.superficie-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.superficie-label {
  font-size: 0.85rem;
  color: #555;
}

.superficie-value-row {
  display: flex;
  align-items: baseline;
  gap: 4px;
}

.superficie-value {
  font-size: 1.2rem;
  font-weight: 700;
  color: #004b80;
}

.superficie-unit {
  font-size: 0.85rem;
  font-weight: 600;
  color: #004b80;
}

/* contenedor de la imagen */
.superficie-thumb {
  flex-shrink: 0;
  width: 100%;          /* ocupa todo el ancho de la tarjeta */
  height: 170px;        /* alto fijo aprox 4,5 cm */
  border-radius: 4px;
  border: 1px solid #ccc;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;   /* üëà ahora fondo blanco */
}

.superficie-thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain;  /* no recorta la imagen, la ajusta */
}

/* en mobile se mantiene igual (no hace falta override) */


    /* PANEL MOVIMIENTO */
    .panel-movimiento { grid-area: movimiento; }

    .mov-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    .mov-col {
      width: 48%;
    }

    .mov-label {
      font-size: 0.95rem;
      color: #444;
      margin-bottom: 6px;
    }

    .mov-pista {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mov-num {
      background: #6b2f82;
      color: #fff;
      font-weight: 700;
      font-size: 1.4rem;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mov-orient {
      font-size: 1.4rem;
      font-weight: 600;
      color: #004b80;
    }

    .mov-icon {
      width: 48px;
      opacity: 0.8;
    }

    .mov-dim-box {
      background: #d1d1d1;
      padding: 6px 14px;
      border-radius: 4px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      display: inline-block;
    }

    .mov-material {
      margin-top: 6px;
      font-size: 0.92rem;
      color: #555;
      font-weight: 500;
    }

    .mov-seccion {
      margin-top: 4px;
    }

    .mov-list {
      margin-top: 8px;
    }

    .mov-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1rem;
      color: #444;
    }

    .mov-badge {
      background: #6b2f82;
      color: #fff;
      font-weight: 700;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* PANEL TERMINAL (columna central grande) */
    .panel-terminal { grid-area: terminal; }

    /* PANEL UBICACI√ìN (con mapa) */
    .panel-ubicacion { grid-area: ubicacion; }

    .map-kpi {
      margin-top: 10px;
      height: 180px;
      border-radius: 4px;
      border: 1px solid #d0d7e2;
      overflow: hidden;
    }

    /* PANEL CONCESI√ìN / EMPLEO / SERVICIOS */
    .panel-concesion { grid-area: concesion; }
    .panel-empleo { grid-area: empleo; }
    .panel-servicios { grid-area: servicios; }

    footer {
      border-top: 1px solid #dde2e6;
      background-color: #ffffff;
      margin-top: 24px;
      font-size: 0.83rem;
      color: #555;
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 16px;
      text-align: right;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
        grid-template-areas:
          "superficie"
          "movimiento"
          "terminal"
          "ubicacion"
          "concesion"
          "empleo"
          "servicios";
      }
      header.page-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .selector { align-items: flex-start; }
      .kpi-strip {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .superficie-kpi {
        flex-direction: column;
        align-items: stretch;
      }
      .superficie-thumb {
        width: 100%;
        height: 180px;
      }
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-inner">
      <div>Presidencia de la Naci√≥n</div>
      <div><a href="index.html" style="color:#fff;text-decoration:none;">GeoData</a></div>
    </div>
  </div>

  <!-- HEADER ORSNA -->
  <div class="gov-header">
    <div class="gov-header-inner">
      <div class="brand">
        <div class="brand-logo"></div>
        <div class="brand-text">
          <span>Organismo Regulador del Sistema Nacional de Aeropuertos</span>
          <span>ORSNA</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BREADCRUMB -->
  <nav class="breadcrumb">
    <div class="breadcrumb-inner">
      <a href="index.html">Inicio</a> ‚Ä∫ Datos clave por aeropuerto
    </div>
  </nav>

  <main>
    <header class="page-header">
      <div class="page-header-left">
        <h1 id="pageTitle">Datos clave por aeropuerto</h1>
        <p id="pageSubtitle">
          Sistema Nacional de Aeropuertos ¬∑ Datos Clave 2025
        </p>
      </div>

      <div class="selector">
        <label for="airportSelect">Seleccionar aeropuerto</label>
        <select id="airportSelect">
          <option value="">Cargando aeropuertos...</option>
        </select>
      </div>
    </header>

    <!-- BANDA KPI -->
    <section class="kpi-strip">
      <div class="kpi-card">
        <img src="img/icons/checkin.png" alt="Check-in">
        <div class="kpi-value" id="kpiCheckin">‚Äì</div>
        <div class="kpi-label">Mostradores</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/boarding.png" alt="Puertas de embarque">
        <div class="kpi-value" id="kpiPuertas">‚Äì</div>
        <div class="kpi-label">Puertas embarque</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/baggage.png" alt="Cintas de equipaje">
        <div class="kpi-value" id="kpiCintas">‚Äì</div>
        <div class="kpi-label">Cintas equipaje</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/PSN.png" alt="PSN">
        <div class="kpi-value" id="kpiPSN">‚Äì</div>
        <div class="kpi-label">PSN totales</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/estacionamiento.png" alt="Estacionamiento">
        <div class="kpi-value" id="kpiEstac">‚Äì</div>
        <div class="kpi-label">Estacionamiento</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/manga.png" alt="Mangas">
        <div class="kpi-value" id="kpiMangas">‚Äì</div>
        <div class="kpi-label">Mangas</div>
      </div>
      <div class="kpi-card">
        <img src="img/icons/PSA.png" alt="PSA">
        <div class="kpi-value" id="kpiPSA">‚Äì</div>
        <div class="kpi-label">Puestos PSA</div>
      </div>
    </section>

    <section class="grid">

      <!-- PANEL 1: SUPERFICIE -->
      <section class="panel panel-superficie">
        <div class="panel-header">Superficie</div>
        <div class="panel-body">

          <!-- KPI: Tama√±o del predio -->
          <div class="superficie-kpi">
            <div class="superficie-text">
              <div class="superficie-label">Tama√±o del predio</div>
              <div class="superficie-value-row">
                <span id="supPredio" class="superficie-value"></span>
                <span class="superficie-unit">hect√°reas</span>
              </div>
            </div>
            <div class="superficie-thumb">
              <img id="imgPredio" alt="Imagen del predio del aeropuerto">
            </div>
          </div>

          <!-- KPI: Terminal de pasajeros -->
          <div class="superficie-kpi">
            <div class="superficie-text">
              <div class="superficie-label">Terminal de pasajeros</div>
              <div class="superficie-value-row">
                <span id="terminalM2" class="superficie-value"></span>
                <span class="superficie-unit">m¬≤</span>
              </div>
            </div>
            <div class="superficie-thumb">
              <img id="imgTerminal" alt="Imagen de la terminal del aeropuerto">
            </div>
          </div>

        </div>
      </section>

      <!-- PANEL 2: √ÅREA DE MOVIMIENTO -->
      <section class="panel panel-movimiento">
        <div class="panel-header">√Årea de movimiento</div>
        <div class="panel-body">
          <div class="mov-row">
            <div class="mov-col">
              <div class="mov-label">Pistas de aterrizaje</div>
              <div class="mov-pista">
                <div class="mov-num" id="cantPistas">‚Äì</div>
                <div class="mov-orient" id="pistaOrient">‚Äì</div>
                <img src="img/icons/runway.png" class="mov-icon" alt="Pista">
              </div>
            </div>

            <div class="mov-col">
              <div class="mov-label">Longitud de la pista principal</div>
              <div class="mov-dim-box" id="dimensiones">‚Äì</div>
              <div class="mov-label" style="margin-top:8px;">Material de pista</div>
              <div class="mov-material" id="materialPista">‚Äì</div>
            </div>
          </div>

          <div class="mov-seccion">
            <div class="mov-label">Posiciones en plataforma</div>
            <div class="mov-list">
              <div class="mov-item">
                <span>Aeronaves comerciales</span>
                <span class="mov-badge" id="psnCom">‚Äì</span>
              </div>
              <div class="mov-item">
                <span>Aviaci√≥n general</span>
                <span class="mov-badge" id="psnGen">‚Äì</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL 3: TERMINAL Y SERVICIOS A PASAJEROS -->
      <section class="panel panel-terminal">
        <div class="panel-header">Terminal de pasajeros</div>
        <div class="panel-body">
          <div class="metric-row">
            <span>Superficie de terminal</span>
            <span class="value" id="terminalM2Dup">‚Äì</span>
          </div>
          <div class="small-label">m¬≤</div>

          <div class="metric-row" style="margin-top:6px;">
            <span>Mostradores de check-in</span>
            <span class="value" id="mostradoresCheckin">‚Äì</span>
          </div>

          <div class="metric-row">
            <span>Kioscos self check-in</span>
            <span class="value" id="kioscosSelf">‚Äì</span>
          </div>

          <div class="metric-row">
            <span>Puertas de embarque (total)</span>
            <span class="value" id="puertasTotal">‚Äì</span>
          </div>
          <div class="small-label" id="puertasDetalle">‚Äì</div>

          <div class="metric-row" style="margin-top:6px;">
            <span>Mangas telesc√≥picas</span>
            <span class="value" id="mangas">‚Äì</span>
          </div>

          <div class="metric-row">
            <span>Cintas de equipaje (total)</span>
            <span class="value" id="cintasTotal">‚Äì</span>
          </div>
          <div class="small-label" id="cintasDetalle">‚Äì</div>

          <div class="metric-row" style="margin-top:6px;">
            <span>Plazas de estacionamiento vehicular</span>
            <span class="value" id="estacionamiento">‚Äì</span>
          </div>

          <div class="metric-row">
            <span>Carritos porta equipajes</span>
            <span class="value" id="carritos">‚Äì</span>
          </div>
        </div>
      </section>

      <!-- PANEL 4: UBICACI√ìN Y ACCESIBILIDAD (con mapa Leaflet) -->
      <section class="panel panel-ubicacion">
        <div class="panel-header">Ubicaci√≥n y accesibilidad</div>
        <div class="panel-body">
          <div class="small-label">Ubicaci√≥n</div>
          <div class="small-label" id="ubicacionText">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Distancia al centro de la ciudad</div>
          <div class="small-label" id="distanciaCentro">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Horario de operaci√≥n</div>
          <div class="small-label" id="horarioOperacion">‚Äì</div>

          <!-- KPI de mapa -->
          <div id="map" class="map-kpi"></div>
        </div>
      </section>

      <!-- PANEL 5: CONCESI√ìN Y EXPLOTACI√ìN -->
      <section class="panel panel-concesion">
        <div class="panel-header">Concesi√≥n y explotaci√≥n</div>
        <div class="panel-body">
          <div class="metric-row">
            <span>Superficie concesionada</span>
            <span class="value" id="supConcesionadaHa">‚Äì</span>
          </div>
          <div class="small-label">hect√°reas</div>

          <div class="small-label" style="margin-top:6px;">√Åreas concesionadas</div>
          <div class="small-label" id="areasConcesionadas">‚Äì</div>

          <div class="small-label" style="margin-top:10px;">Explotador</div>
          <div class="small-label" id="explotador">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Grupo de concesi√≥n</div>
          <div class="small-label" id="grupo">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Concesi√≥n hasta</div>
          <div class="small-label" id="concesionHasta">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">C√≥digos</div>
          <div class="small-label" id="codigos">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Habilitaci√≥n</div>
          <div class="small-label" id="habilitacion">‚Äì</div>
        </div>
      </section>

      <!-- PANEL 6: EMPLEO Y POBLACI√ìN -->
      <section class="panel panel-empleo">
        <div class="panel-header">Empleo y √°rea de influencia</div>
        <div class="panel-body">
          <div class="small-label">Empleo directo 2024</div>
          <div class="metric-row">
            <span>Personas empleadas</span>
            <span class="value" id="empleoDirecto">‚Äì</span>
          </div>

          <div class="small-label" style="margin-top:6px;">Poblaci√≥n del √°rea de influencia (Censo 2022)</div>
          <div class="metric-row">
            <span>Poblaci√≥n estimada</span>
            <span class="value" id="poblacionInfluencia">‚Äì</span>
          </div>
        </div>
      </section>

      <!-- PANEL 7: SERVICIOS Y AYUDAS -->
      <section class="panel panel-servicios">
        <div class="panel-header">Servicios y ayudas</div>
        <div class="panel-body">
          <div class="small-label">Ayudas radioel√©ctricas</div>
          <div class="small-label" id="radioayudas">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Ayudas visuales</div>
          <div class="small-label" id="ayudasVisuales">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">AWOS</div>
          <div class="small-label" id="awos">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Operador de cargas</div>
          <div class="small-label" id="operadorCargas">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Terminal de cargas (m¬≤)</div>
          <div class="small-label" id="terminalCargasM2">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Aeroplantas</div>
          <div class="small-label" id="aeroplantas">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Clave de referencia de aer√≥dromo</div>
          <div class="small-label" id="claveRef">‚Äì</div>

          <div class="small-label" style="margin-top:6px;">Categor√≠a SEI normal</div>
          <div class="small-label" id="categoriaSEI">‚Äì</div>
        </div>
      </section>

    </section>
  </main>

  <footer>
    <div class="footer-inner" id="footerNote">
      Fuente: ORSNA ‚Äì Datos de la planilla b√°sica por aeropuerto.
    </div>
  </footer>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <script>
    let aeropuertos = [];
    let poligonos = [];
    const selectEl = document.getElementById("airportSelect");
    let map, mapMarker, poligonoLayer;

    function formatNumber(n) {
      if (n === null || n === undefined || n === "" || isNaN(n)) return "‚Äì";
      return Number(n).toLocaleString("es-AR");
    }

    function clean(text) {
      if (text === null || text === undefined) return "";
      return String(text).trim();
    }

    function safeVal(v) {
      return (v !== null && v !== undefined && v !== "" && !isNaN(v))
        ? formatNumber(v)
        : (clean(v) || "‚Äì");
    }

    function initMap() {
      map = L.map("map").setView([-34.6, -58.4], 5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      mapMarker = L.marker([-34.6, -58.4]).addTo(map);
    }

    function updateMapForAirport(a) {
      if (!map) return;

      // Limpiamos pol√≠gono anterior si existe
      if (poligonoLayer) {
        map.removeLayer(poligonoLayer);
        poligonoLayer = null;
      }

      const iata = a.IATA;

      // 1) Intentar dibujar pol√≠gono(s) del predio para este IATA
      if (poligonos.length > 0 && iata) {
        const feats = poligonos.filter(f => {
          const props = f.properties || {};
          const code = props.IATA || props.iata || props.iata_code;
          return String(code).toUpperCase() === String(iata).toUpperCase();
        });

        if (feats.length > 0) {
          poligonoLayer = L.geoJSON(feats, {
            style: {
              color: "#0072bb",
              weight: 2,
              fillColor: "#4fa3ff",
              fillOpacity: 0.35
            }
          }).addTo(map);

          const bounds = poligonoLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [5, 5] });
          }

          // Opcional: ocultar marcador si hay pol√≠gono
          if (mapMarker) {
            map.removeLayer(mapMarker);
          }
          return;
        }
      }

      // 2) Si no hay pol√≠gono, usamos Lat/Lon como fallback
      let lat = a["Lat"] || a["LAT"];
      let lon = a["Lon"] || a["LON"] || a["Long"];

      if (lat && lon && !isNaN(Number(lat)) && !isNaN(Number(lon))) {
        const latNum = Number(lat);
        const lonNum = Number(lon);

        map.setView([latNum, lonNum], 11);

        if (!mapMarker) {
          mapMarker = L.marker([latNum, lonNum]).addTo(map);
        } else {
          mapMarker.setLatLng([latNum, lonNum]).addTo(map);
        }
      } else {
        // Vista general si no hay datos
        map.setView([-34.6, -58.4], 5);
        if (mapMarker) {
          mapMarker.setLatLng([-34.6, -58.4]).addTo(map);
        }
      }
    }

    function renderAirport(iataCode) {
      const a = aeropuertos.find(x => x.IATA === iataCode);
      if (!a) return;

      const nombre = clean(a["Aeropuerto"]) || clean(a["Nombre del Aeropuerto"]) || a.IATA;
      document.getElementById("pageTitle").textContent =
        `Aeropuerto de ${nombre} (${a.IATA})`;
      document.getElementById("pageSubtitle").textContent =
        `Sistema Nacional de Aeropuertos ¬∑ Datos Clave ${a["A√±o"] || ""}`;

      /* KPI strip */
      document.getElementById("kpiCheckin").textContent =
        safeVal(a["Mostradores Check in"]);
      document.getElementById("kpiPuertas").textContent =
        safeVal(a["PuertasEmbarqueTotal"]);
      document.getElementById("kpiCintas").textContent =
        safeVal(a["CintasTotal"]);
      document.getElementById("kpiPSN").textContent =
        safeVal(a["PSNTotal"]);
      document.getElementById("kpiEstac").textContent =
        safeVal(a["Estacionamiento Vehicular"]);
      document.getElementById("kpiMangas").textContent =
        safeVal(a["Mangas telesc√≥picas"]);
      document.getElementById("kpiPSA").textContent =
        safeVal(a["PSAScanTotal"]);

      /* SUPERFICIE */
      document.getElementById("supPredio").textContent =
        safeVal(a["SupPredioHa"]);
      document.getElementById("terminalM2").textContent =
        safeVal(a["TerminalM2"]);

      const imgPredio = document.getElementById("imgPredio");
      const imgTerminal = document.getElementById("imgTerminal");
      const iataUpper = String(a.IATA || "").toUpperCase();

      const predioProp = clean(a["imagenPredio"]);
      const terminalProp = clean(a["imagenAeropuerto"]);

      // Rutas din√°micas seg√∫n IATA
      const predioSrc = predioProp || (iataUpper ? `img/Predios/${iataUpper}.png` : "");
      const terminalSrc = terminalProp || (iataUpper ? `img/Terminales/${iataUpper}_terminal.png` : "");

      imgPredio.style.display = predioSrc ? "block" : "none";
      imgTerminal.style.display = terminalSrc ? "block" : "none";

      imgPredio.src = predioSrc;
      imgPredio.alt = `Predio del aeropuerto ${nombre}`;
      imgTerminal.src = terminalSrc;
      imgTerminal.alt = `Terminal del aeropuerto ${nombre}`;

      imgPredio.onerror = () => {
        imgPredio.style.display = "none";
      };
      imgTerminal.onerror = () => {
        imgTerminal.style.display = "none";
      };

      /* √ÅREA DE MOVIMIENTO */
      const orient = clean(a["PistaOrientacion"]);
      document.getElementById("pistaOrient").textContent = orient || "‚Äì";

      const dims = clean(a["Dimensiones"]);
      document.getElementById("dimensiones").textContent = dims || "‚Äì";

      document.getElementById("materialPista").textContent =
        clean(a["MaterialPista"]) || "‚Äì";

      let pistas = 1;
      if (orient) {
        pistas = orient.split(";").filter(Boolean).length;
      }
      document.getElementById("cantPistas").textContent = pistas;

      const psnCom = (a["PSN_C"] !== undefined && a["PSN_C"] !== "")
        ? a["PSN_C"]
        : (a["PSNRemotasC"] !== undefined ? a["PSNRemotasC"] : "");
      const psnGen = (a["PSN_AG"] !== undefined && a["PSN_AG"] !== "")
        ? a["PSN_AG"]
        : (a["PSNRemotasAG"] !== undefined ? a["PSNRemotasAG"] : "");

      document.getElementById("psnCom").textContent =
        psnCom !== "" ? safeVal(psnCom) : "‚Äì";
      document.getElementById("psnGen").textContent =
        psnGen !== "" ? safeVal(psnGen) : "‚Äì";

      /* TERMINAL */
      document.getElementById("terminalM2Dup").textContent =
        safeVal(a["TerminalM2"]);
      document.getElementById("mostradoresCheckin").textContent =
        safeVal(a["Mostradores Check in"]);
      document.getElementById("kioscosSelf").textContent =
        safeVal(a["Kioscos         (self check In)"]);
      document.getElementById("puertasTotal").textContent =
        safeVal(a["PuertasEmbarqueTotal"]);

      const puertasDetalle = [];
      if (a["PuertasEmbarqueInter"]) puertasDetalle.push(`Inter: ${a["PuertasEmbarqueInter"]}`);
      if (a["PuertasEmbarqueCabot"]) puertasDetalle.push(`Cabot: ${a["PuertasEmbarqueCabot"]}`);
      if (a["PuertasEmbarqueFlex"]) puertasDetalle.push(`Flex: ${a["PuertasEmbarqueFlex"]}`);
      document.getElementById("puertasDetalle").textContent =
        puertasDetalle.length ? puertasDetalle.join(" ¬∑ ") : "‚Äì";

      document.getElementById("mangas").textContent =
        safeVal(a["Mangas telesc√≥picas"]);
      document.getElementById("cintasTotal").textContent =
        safeVal(a["CintasTotal"]);

      const cintasDetalle = [];
      if (a["CintasInter"]) cintasDetalle.push(`Inter: ${a["CintasInter"]}`);
      if (a["CintasCabot"]) cintasDetalle.push(`Cabot: ${a["CintasCabot"]}`);
      if (a["CintasFlex"]) cintasDetalle.push(`Flex: ${a["CintasFlex"]}`);
      document.getElementById("cintasDetalle").textContent =
        cintasDetalle.length ? cintasDetalle.join(" ¬∑ ") : "‚Äì";

      document.getElementById("estacionamiento").textContent =
        safeVal(a["Estacionamiento Vehicular"]);
      document.getElementById("carritos").textContent =
        safeVal(a["Carritos porta equipajes"]);

      /* UBICACI√ìN */
      const loc = `${clean(a["Localidad"])} ¬∑ ${clean(a["Provincia"])}`
        .replace(/^ ¬∑ | ¬∑ $/g, "");
      document.getElementById("ubicacionText").textContent = loc || "‚Äì";

      const dist = a["Distancia al centro de la ciudad (km)"];
      document.getElementById("distanciaCentro").textContent =
        dist ? `${formatNumber(dist)} km` : "‚Äì";

      document.getElementById("horarioOperacion").textContent =
        clean(a["Horario de operaci√≥n"]) || "‚Äì";

      // Actualizar mapa (pol√≠gono o punto)
      updateMapForAirport(a);

      /* CONCESI√ìN Y EXPLOTACI√ìN */
      document.getElementById("supConcesionadaHa").textContent =
        safeVal(a["SupConcesionadaHa"]);
      document.getElementById("areasConcesionadas").textContent =
        clean(a["AreasConcesionadas"]) || "‚Äì";

      document.getElementById("explotador").textContent =
        clean(a["Explotador"]) || "‚Äì";
      document.getElementById("grupo").textContent =
        clean(a["Grupo"]) || "‚Äì";
      document.getElementById("concesionHasta").textContent =
        clean(a["ConcesionHasta"]) || "‚Äì";

      const cods = [];
      if (clean(a["OACI"])) cods.push(`OACI: ${clean(a["OACI"])}`);
      if (clean(a["ANAC"])) cods.push(`ANAC: ${clean(a["ANAC"])}`);
      if (clean(a["IATA"])) cods.push(`IATA: ${clean(a["IATA"])}`);
      document.getElementById("codigos").textContent =
        cods.length ? cods.join(" ¬∑ ") : "‚Äì";

      document.getElementById("habilitacion").textContent =
        clean(a["Habilitaci√≥n"]) || "‚Äì";

      /* EMPLEO Y POBLACI√ìN */
      document.getElementById("empleoDirecto").textContent =
        safeVal(a["EmpleoDirecto2024"]);
      document.getElementById("poblacionInfluencia").textContent =
        safeVal(a["Poblaci√≥n del √Årea de Influencia (Censo 2022)"]);

      /* SERVICIOS Y AYUDAS */
      document.getElementById("radioayudas").textContent =
        clean(a["Radioayudas"]) || "‚Äì";
      document.getElementById("ayudasVisuales").textContent =
        clean(a["Ayudas visuales"]) || "‚Äì";
      document.getElementById("awos").textContent =
        clean(a["AWOS"]) || "‚Äì";

      document.getElementById("operadorCargas").textContent =
        clean(a["OperadorCargas"]) || "‚Äì";
      document.getElementById("terminalCargasM2").textContent =
        safeVal(a["TerminalCargasM2"]);

      const aeroComb = [];
      if (a["Aeroplantas AV GAS"]) aeroComb.push(`AV GAS: ${a["Aeroplantas AV GAS"]}`);
      if (a["Aeroplantas JP1"]) aeroComb.push(`JP1: ${a["Aeroplantas JP1"]}`);
      document.getElementById("aeroplantas").textContent =
        aeroComb.length ? aeroComb.join(" ¬∑ ") : "‚Äì";

      document.getElementById("claveRef").textContent =
        clean(a["CLAVE DE REFERENCIA DE AER√ìDROMO"]) || "‚Äì";
      document.getElementById("categoriaSEI").textContent =
        clean(a["CATEGOR√çA SEI NORMAL"]) || "‚Äì";

      document.getElementById("footerNote").textContent =
        `Fuente: ORSNA ‚Äì Datos b√°sicos por aeropuerto ¬∑ A√±o ${a["A√±o"] || ""}.`;
    }

    async function loadData() {
      try {
        // 1) Datos b√°sicos por aeropuerto
        const resp = await fetch("fuentes/Datos_aeropuertos.geojson");
        const geojson = await resp.json();

        const features = geojson.features || [];
        aeropuertos = features
          .map(f => f.properties || {})
          .filter(p => p.IATA);

        aeropuertos.sort((a, b) => String(a.IATA).localeCompare(String(b.IATA)));

        selectEl.innerHTML = "";
        aeropuertos.forEach(p => {
          const opt = document.createElement("option");
          const nombre = clean(p["Aeropuerto"]) || clean(p["Nombre del Aeropuerto"]) || p.IATA;
          opt.value = p.IATA;
          opt.textContent = `${nombre} (${p.IATA})`;
          selectEl.appendChild(opt);
        });

        // 2) Pol√≠gonos de predios
        try {
          const respPoly = await fetch("fuentes/poligonos_aeropuertos.geojson");
          const gjPoly = await respPoly.json();
          poligonos = gjPoly.features || [];
        } catch (e) {
          console.warn("No se pudieron cargar los pol√≠gonos de aeropuertos:", e);
          poligonos = [];
        }

        // Selecci√≥n inicial
        const params = new URLSearchParams(window.location.search);
        const fromUrl = params.get("airport");
        let initial = aeropuertos[0]?.IATA;
        if (fromUrl && aeropuertos.find(a => String(a.IATA) === String(fromUrl))) {
          initial = fromUrl;
        }

        if (initial) {
          selectEl.value = initial;
          renderAirport(initial);
        }

        selectEl.addEventListener("change", e => {
          renderAirport(e.target.value);
          const url = new URL(window.location.href);
          url.searchParams.set("airport", e.target.value);
          window.history.replaceState({}, "", url);
        });
      } catch (err) {
        console.error("Error cargando GeoJSON:", err);
        selectEl.innerHTML = "<option>Error al cargar datos</option>";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
    });
  </script>
</body>
</html>
